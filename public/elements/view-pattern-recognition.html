<link rel="import" href="../bower_components/polymer/polymer.html" />
<link rel="import" href="../bower_components/app-router/app-router.html" />
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html" />

<dom-module id="view-pattern-recognition">
  <template>
    <style>
      .nav-link.active {
        background: #dee2e6;
      }

      ::content .value-based-container {
        overflow-y: auto;
        background: #dee2e6;
      }

      @media (max-width: 575.98px) {
        ::content .value-based-container {
          width: 100% !important;
        }
      }

      @media (max-width: 1199.98px) {
        ::content .value-based-container {
          width: 340px !important;
        }
      }

      .searchResult {
        position: absolute;
        top: 38px;
        left: 0;
        width: 100%;
        z-index: 1;
      }

      .searchResult .list-group .list-group-item {
        cursor: pointer !important;
      }

      .searchResult .list-group .list-group-item div {
        word-wrap: break-word;
      }

      .form-icon {
        font-size: 20px;
        cursor: pointer;
      }

      .hr-text {
        line-height: 1em;
        position: relative;
        outline: 0;
        border: 0;
        color: #343a40;
        text-align: center;
        height: 1.5em;
        margin: 0;
      }

      .hr-text:before {
        content: "";
        background: linear-gradient(to right,
            transparent,
            #818078,
            transparent);
        position: absolute;
        left: 0;
        top: 50%;
        width: 100%;
        height: 1px;
      }

      .hr-text:after {
        content: attr(data-content);
        position: relative;
        display: inline-block;
        padding: 0 0.5em;
        line-height: 1.5em;
        color: #343a40;
        background-color: #dee2e6;
      }

      .TagHeading {
        font-size: 17px;
      }

      .TagDesc {
        font-size: 13px;
      }

      .fas {
        cursor: pointer;
      }

      .alert-info {
        z-index: 10;
      }

      ::content .highcharts-legend-item-hidden tspan {
        fill: #ccc !important;
      }

      .fa-info-circle {
        outline-color: transparent;
        text-decoration: none;
        color: #343a40;
        cursor: pointer;
        font-size: 16px;
      }

      .selectedCriteria {
        background-color: rgba(255, 255, 255, 0.5);
      }

      #similaritySearchResult li {
        border-top-color: #f8f9fa !important;
      }

      .searchResult .description {
        justify-content: space-between;
      }

      .selectedTagName {
        word-break: break-all;
      }

      #trendAlerts {
        white-space: pre-line;
      }

      .saveFP-action span {
        max-width: 0;
        -webkit-transition: max-width 1s;
        transition: max-width 1s;
        display: inline-block;
        vertical-align: top;
        white-space: nowrap;
        overflow: hidden;
      }

      .saveFP-action:hover span {
        max-width: 7rem;
      }

      .saveFPUploadContainer {
        position: relative;
        overflow: hidden;
      }

      .saveFPUpload {
        position: absolute;
        font-size: 50px;
        opacity: 0;
        right: 0;
        top: 0;
        cursor: pointer;
      }

      ::content .highcharts-point {
        display: none;
      }
    </style>

    <div class="container-fluid h-100 container-with-sidebar">
      <div class="d-flex h-100">
        <nav class="bg-light sidebar position-fixed h-100 text-center border-right">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link text-dark px-4 py-3" href="#/trend-analysis" on-click="(_toggleSearch)"
                data-toggle="tooltip" data-placement="right" title="Tag Search">
                <i class="fas fa-tag"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark px-4 py-3" href="#/trend-analysis/value-based-search" data-toggle="tooltip"
                data-placement="right" title="Value Based Search">
                <i class="fas fa-search"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark px-4 py-3 active" href="#/trend-analysis/pattern-recognition"
                data-toggle="tooltip" data-placement="right" title="Pattern Recognition">
                <i class="fas fa-chart-line"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark px-4 py-3" href="#/trend-analysis/correlation-matrix" data-toggle="tooltip"
                data-placement="right" title="Correlation Matrix">
                <i class="fas fa-ruler-combined"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-dark px-4 py-3 " href="#/trend-analysis/driving-factors" data-toggle="tooltip"
                data-placement="right" title="Driving Factors">
                <i class="fas fa-file-contract"></i>
              </a>
            </li>
            <!-- <li class="nav-item">
              <a class="nav-link text-dark px-4 py-3 " href="#/trend-analysis/statistical-profile" data-toggle="tooltip"
                data-placement="right" title="Statistical Profile">
                <i class="far fa-file-alt"></i>
              </a>
            </li> -->
            <li class="nav-item">
              <a class="nav-link text-dark px-4 py-3 " href="#/trend-analysis/work-organizer" data-toggle="tooltip"
                data-placement="right" title="Work Organizer">
                <i class="fas fa-tasks"></i>
              </a>
            </li>
            <!-- <li class="nav-item">
              <a class="nav-link text-dark px-4 py-3 " href="#/trend-analysis/predication" data-toggle="tooltip"
                data-placement="right" title="Predication">
                <i class="fab fa-hubspot"></i>
              </a>
            </li> -->
          </ul>
        </nav>

        <div class="value-based-container h-100 w-25">
          <div class=" flex-column pt-2  h-100 border-right">
            <div class="px-3">
              <div class="lead pb-2 d-flex justify-content-between  border-bottom border-light mb-2">
                <div><strong>Pattern Recognition</strong></div>
                <template is="dom-if" if="[[!saveFingerPrintCheck]]">
                  <a href="JavaScript:(0);" title="Pattern Recognition" data-toggle="popover" data-placement="bottom"
                    data-trigger="focus" data-html="true" data-content="placeholder for description"><i
                      class="fas fa-info-circle "></i></a>
                </template>
                <template is="dom-if" if="[[saveFingerPrintCheck]]">
                  <div on-click="_openFingerPrint"
                    class="file saveFPUploadContainer saveFP-action mr-1 pr-1 btn btn-sm btn-outline-primary">
                    <i class="far fa-file-alt"></i>
                    <span>Save</span>
                    <input class="saveFPUpload" type="button" />
                  </div>
                </template>
              </div>
              <form id="fingerPrintForm" class="collapse" onsubmit="return false">
                <div class="mb-3">
                  <div style="position:relative;" class="form-group mb-2 d-flex flex-row">
                    <input type="text" required readonly autocomplete="off" class="form-control"
                      placeholder="Search tag" id="searchedTag" name="searchedTag" value="{{searchedTagNameValue}}">
                  </div>
                  <div class="form-group mb-1">
                    <label class="col-form-label py-1" for="similarityPriority">Priority</label>
                    <select required class="form-control" name="similarityPriority" on-change=""
                      id="similarityPriority">
                      <option>High </option>
                      <option>Medium</option>
                      <option>Low</option>
                    </select>
                  </div>
                  <div class="form-group mb-1">
                    <label class="col-form-label py-1" for="fpStartDate">Start Date</label>
                    <input id="startDate" type="text" class="form-control" name="fpStartDate" />
                  </div>
                  <div class="form-group mb-1">
                    <label for="similarityPercentage" class="col-form-label py-1">Minimum score
                      (0%-100%)</label>
                    <div class="d-flex justify-content-between">
                      <input required type="number" min="0" onkeypress="return event.charCode >= 48" max="100"
                        class="form-control  " on-change="" name="similarityPercentage" id="similarityPercentage">
                    </div>
                  </div>

                  <div class="form-group mb-1">
                    <label class="col-form-label py-1" for="fpName">Name</label>
                    <input required type="text" class="form-control" id="fpName" name="fpName" />
                  </div>
                  <div class="form-group mb-1">
                    <label class="col-form-label py-1" for="description">Description</label>
                    <textarea required type="text" class="form-control" id="description" name="description"></textarea>
                  </div>
                  <div class="custom-control custom-switch mb-1">
                    <input type="checkbox" class="custom-control-input" id="addfingerprinttatus">
                    <label class="custom-control-label" for="addfingerprinttatus">Active</label>
                  </div>
                  <div class="custom-control custom-switch mb-1">
                    <input type="checkbox" class="custom-control-input" on-click="_addfpNotificaiton"
                      id="addfpNotificaiton">
                    <label class="custom-control-label" for="addfpNotificaiton">Notification</label>
                  </div>
                  <template is="dom-if" if="[[fpNotificaiton]]">
                    <div class="form-group mb-2">
                      <label class="col-form-label py-1" for="addEmail">Email</label>
                      <input type="text" class="form-control" id="addEmail" placeholder="Email">
                    </div>
                  </template>
                  <div class="d-flex flex-row">
                    <button type="button" class="btn btn-primary btn-sm col-md-6 mr-1"
                      on-click="_cancelFingerPrint">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-sm col-md-6 ml-1"
                      on-click="_saveFingerPrint">Save</button>
                  </div>
                </div>
              </form>
              <form id="similarityBasedSearchForm" onsubmit="return false">
                <div id="trendCheck">
                  <div style="position:relative;" class="form-group mb-2 d-flex flex-row">
                    <input type="text" required autocomplete="off" class="form-control" placeholder="Search tag"
                      id="searchedTag" value="{{searchedTagNameValue}}" name="searchedTag" />
                    <template is="dom-if" if="{{tagSearchResult}}">
                      <div class="searchResult">
                        <ul class="list-group">
                          <template is="dom-repeat" items="[[tagSearchResult]]" as="tagResults">
                            <li on-click="_addTag" data-tagSelected$="[[tagResults.tag_id]]"
                              data-tagName$="[[tagResults.tag_name]]"
                              class="border-none  list-group-item px-2 py-1 border-top rounded-0">
                              <div class="h6 mb-0">[[tagResults.tag_name]]</div>
                              <div class="text-black-50 mb-0 text-wrap d-flex description">
                                <span class="text-truncate w-50">[[tagResults.description]]
                                </span>
                                <span
                                  class="font-weight-light text-muted "><small>[[_showTimestamp(tagResults.min_date)]]/[[_showTimestamp(tagResults.max_date)]]</small></span>
                              </div>
                            </li>
                          </template>
                        </ul>
                      </div>
                    </template>
                  </div>
                  <div class="form-group mb-2">
                    <label for="trendSearchRange" class="col-form-label py-1 ">Trend Range</label>
                    <input id="trendSearchRange" type="text" class="form-control" name="datetimes" />
                  </div>
                  <div class="d-flex flex-row">
                    <button type="button" class="btn btn-primary btn-sm btn-block " on-click="_getTagTrend">
                      Search
                    </button>
                  </div>
                </div>

                <template is="dom-if" if="[[similarityCheck]]" restamp>
                  <div class="form-group selectedCriteria p-2 rounded text-muted mb-2 mt-2">
                    <div class="d-flex">
                      <label class=" lead flex-grow-1 col-form-label py-1"><strong>Selected Criteria</strong></label>
                      <i on-click="_backtoTrends" class="fas fa-undo"></i>
                    </div>
                    <div class="d-flex  align-items-center">
                      <label class="flex-grow-1 lead col-form-label py-1">Tag Name:
                      </label>
                      <span class="selectedTagName">{{searchedTagNameValue}}</span>
                    </div>
                    <div class="d-flex  align-items-center">
                      <label class="flex-grow-1 lead col-form-label py-1">
                        Trend From:
                      </label>
                      <span>{{criteriaStartDateRange}}</span>
                    </div>
                    <div class="d-flex  align-items-center">
                      <label class="flex-grow-1 lead col-form-label py-1">
                        Trend To:
                      </label>
                      <span>{{criteriaEndDateRange}}</span>
                    </div>
                  </div>
                  <template is="dom-if" if="[[addConditionalTags]]" restamp>
                    <template is="dom-repeat" items="{{addConditionalTags}}" as="addConditionalTag" restamp>
                      <hr class="hr-text " data-content="AND" />
                      <div id$=tag[[index]] class="d-flex align-items-center">
                        <div class="tagVarElement " style="position:relative;width: 100%;">
                          <input type="text" autocomplete="off" on-input="_openList" pattern="^[a-zA-Z0-9_]*$"
                            class="form-control" name="[[index]]" id$="[[index]]" />
                          <div id$="searchResult_[[index]]" class="searchResult">
                            <ul class="list-group">
                              <template is="dom-repeat" items="[[tagSearchResult]]" as="tagResults">
                                <li on-click="_tagSelected" data-tagSelected$="[[tagResults.tag_id]]"
                                  data-tagName$="[[tagResults.tag_name]]"
                                  class="border-none  list-group-item px-2 py-1 border-top rounded-0">
                                  <span class="h6 d-block mb-0"
                                    style="overflow-wrap: break-word;">[[tagResults.tag_name]]</span>
                                  <div class="text-black-50 mb-0 text-wrap d-flex description">
                                    <span class="text-truncate w-50">[[tagResults.description]]
                                    </span>
                                    <span
                                      class="font-weight-light text-muted "><small>[[_showTimestamp(tagResults.min_date)]]/[[_showTimestamp(tagResults.max_date)]]</small></span>
                                  </div>
                                </li>
                              </template>
                            </ul>
                          </div>
                        </div>
                        <i id=[[addConditionalTag]] data-inputTagID$=[[index]]
                          class="float-right fas fa-times-circle text-dark p-2 mb-1" on-click="_removeCondition"></i>
                      </div>
                    </template>
                  </template>
                  <div class="form-group mt-2">
                    <i on-click="_addCondition" class="fas fa-plus-circle form-icon"></i><span class="p-1">add
                      tag</span>
                  </div>
                  <div class="form-group mb-2 mt-2">
                    <label for="searchRange" class="col-form-label py-1">Search Range</label>
                    <input id="searchRange" type="text" name="searchRange" class="form-control" />
                  </div>

                  <div class="form-group mb-2">
                    <label class="col-form-label py-1" for="similarityType">Search Type</label>
                    <select required class="form-control" name="similarityType" on-change="_selectionChanged"
                      id="similarityType">
                      <option>Absolute</option>
                      <option>Relative</option>
                    </select>
                  </div>

                  <div class="form-group mb-2 mt-2">
                    <label for="similarityPercentage" class="col-form-label py-1">Minimum score (0%-100%)</label>
                    <div class="d-flex justify-content-between">
                      <input required type="number" min="0" max="100" class="form-control  "
                        on-input="_selectionChanged" name="similarityPercentage" id="similarityPercentage" />
                    </div>
                  </div>
                  <div class="d-flex flex-row">
                    <button id="performSimilaritySearch" type="submit" class="btn btn-primary btn-sm btn-block"
                      on-click="_performSimilaritySearch">
                      Search
                    </button>
                  </div>
                </template>
              </form>
              <template is="dom-if" if="[[similaritySearchResult]]">
                <div class=" pb-2 border-bottom border-light mt-2 col-form-label">
                  <strong>Results ([[totalRecords]])</strong>
                </div>
                <ul id="similaritySearchResult" class="list-group list-group-flush  ">
                  <template is="dom-repeat" items="{{ similaritySearchResult }}" as="similaritySearchResult" restamp>
                    <!-- <template is="dom-if" if="[[similaritySearchResult.data.0.0]]"> -->
                    <li class="list-group-item list-group-item-action  bg-transparent px-2 py-1 border-bottom-0">
                      <small class="lead TagHeading">{{_timezoneConverter(similaritySearchResult.timestamp)}}</small>
                      <span class="float-right mt-3"><i data-resultID$="[[index]]" data-matchType$="{{matchType}}"
                          data-similarMatch$="{{_matchPercentage(similaritySearchResult.similarity)}}"
                          data-similarityTimestamp$="{{similaritySearchResult.timestamp}}" on-click="_showSimilarity"
                          class="fas fa-layer-group"></i></span>
                      <div class="text-black-50 TagDesc">
                        Match :
                        {{_matchPercentage(similaritySearchResult.similarity)}}%
                      </div>
                    </li>
                    <!-- </template> -->
                  </template>
                </ul>
              </template>
            </div>
          </div>
        </div>
        <main role="main" class="p-3 pb-0 flex-grow-1">
          <template is="dom-if" if="[[trendAlerts]]">
            <div style="z-index:10;" class="alert alert-info mb-0 alert-dismissible fade show mb-2" role="alert">
              <button type="button" class="close" data-dismiss="alert" on-click="_dismissAlert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
              <span id="trendAlerts">[[trendAlerts]]</span>
            </div>
          </template>
          <div class="container-fluid" style="position:relative;">
            <div class="row">
              <!-- <template is="dom-if" if="[[tagTrends]]"> </template> -->
              <div id="container" class="mt-3" style="width: 100%; height: 85vh;"></div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <global-loader>
      <iron-ajax auto id="e_searchTag" url="/getTagList" last-response="{{tagDataList}}"
        on-response="_onResponse_searchTag" on-error="_onError"></iron-ajax>
    </global-loader>
    <global-loader>
      <iron-ajax id="e_getTagTrends" last-response="{{tagTrends}}" on-response="_onResponse_getTagTrends"
        handle-as="json" on-error="_onError_getTagTrends">
      </iron-ajax>
    </global-loader>
    <global-loader>
      <iron-ajax method="POST" id="e_similaritySearch" body="{{bodyData}}" handle-as="json"
        content-type="application/json"
        url="/similaritySearch/[[startDate]]/[[endDate]]/[[tagId]]/[[threshold]]/[[similarityType]]"
        on-response="_onResponse_similaritySearch" last-response="{{e_similaritySearchResults}}"
        on-error="_onError_similaritySearch"></iron-ajax>
    </global-loader>
    <global-loader>
      <iron-ajax method="POST" id="e_createFingerPrint" url="/createFingerPrint" body="{{bodyData}}" handle-as="json"
        content-type="application/json" on-response="_onResponse_createFingerPrint"
        on-error="_onError_createFingerPrint">
      </iron-ajax>
    </global-loader>
  </template>

  <script>
    Polymer({
      is: "view-pattern-recognition",
      properties: {
        addConditionalTags: {
          type: Array,
          value: []
        },
        saveFingerPrintCheck: {
          type: Boolean,
          value: false
        },
        fingerPrintAreaPatternList: {
          type: Array,
          value: []
        },
        highchartTrends: {
          type: Array,
          value: []
        },
        fpbackOverlayTimeStamp: {
          value: null
        },
        fpfrontOverlayTimeStamp: {
          value: null
        }
      },
      created: function () {
        document.documentElement.classList.remove("in-progress");
      },
      attached: function () {
        this.async(function () {
          $('[data-toggle="tooltip"]').tooltip();
          $('[data-toggle="popover"]').popover();

          Highcharts.stockChart("container", {
            rangeSelector: {
              inputEnabled: false,
              enabled: false
            },
            legend: {
              enabled: true,
              symbolHeight: 0,
              symbolWidth: 0,
              symbolRadius: 0
            },
            tooltip: {
              xDateFormat: '%Y-%m-%d %H:%M',
              split: false,
              distance: 30,
              padding: 5,
              shared: true
            },

            yAxis: {
              opposite: false
            },
            series: {
              dashStyle: 'Solid'
            },
            plotOptions: {
              series: {
                marker: {
                  enabled: false
                }
              }
            }
          });
        });
      },
      detached: function () {
        var root = this;
        root.addConditionalTags = [];

      },
      ready: function () {

        root = this;
        root.trendTagCheck = false;
        root.addCondTags = [];
        root.dataPattern = [];
        root.searchedTagValue;
        root.selectedDateRange = [];
        root.endDateRange = new Date();
        root.startDateRange = Date.parse(root.endDateRange) - 86400000;
        root.fpStartDateRange = root._timezoneConverter(Date.parse(root.endDateRange) - 86400000);
        root.fpEndDateRange = root._timezoneConverter(new Date());
        root.fingerprintstartDate = root._timezoneConverter(new Date());
        root.searchStartDateRange;
        root.searchEndDateRange;
        root.seriesData;
        root.legends = [];
        root.matchType = "Absolute";
        root.colorCode;
        root.selectedTagList = [];
        root.showSimilarityCheck = false;
        root.criteriaStartDateRange;
        root.criteriaEndDateRange;
        root.timeCoverterCheck = false;

        $(function () {
          // moment.tz.setDefault("Etc/Universal");
          $('input[name="datetimes"]').daterangepicker(
            {
              timePicker: true,
              showDropdowns: true,
              timePicker24Hour: true,
              timePickerSeconds: false,
              alwaysShowCalendars: true,
              maxDate: moment.utc().startOf("minutes"),
              opens: "right",
              ranges: {
                Today: [moment.utc(), moment.utc()],
                Yesterday: [
                  moment.utc().subtract(1, "days"),
                  moment.utc().subtract(1, "days")
                ],
                "Last 7 Days": [moment.utc().subtract(6, "days"), moment.utc()],
                "Last 30 Days": [moment.utc().subtract(29, "days"), moment.utc()],
                "This Month": [
                  moment.utc().startOf("month"),
                  moment.utc().endOf("month")
                ],
                "Last Month": [
                  moment.utc()
                    .subtract(1, "month")
                    .startOf("month"),
                  moment.utc()
                    .subtract(1, "month")
                    .endOf("month")
                ]
              },
              startDate: moment.utc().subtract(1, "day"),
              endDate: moment.utc().startOf("minutes"),
              locale: {
                format: "YYYY-MM-DD HH:mm",
                "applyLabel": "Confirm Dates",
              }
            },
            function (start, end, label) {
              // root = this;

              root.startDateRange = start.format("YYYY-MM-DD HH:mm:ss");
              root.endDateRange = end.format("YYYY-MM-DD HH:mm:ss");
              root.timeCoverterCheck = true;
              root.fpStartDateRange = start.format('YYYY-MM-DD HH:mm:ss');
              root.fpEndDateRange = end.format('YYYY-MM-DD HH:mm:ss');
            }
          );
        });

      },
      _getTagTrend: function (e) {
        root = this;
        if (root.searchedTagValue) {
          root.selectedTagList.push(root.searchedTagValue);
          root.$.trendCheck.style.display = "none";
          root.similarityCheck = true;
          root._getTrends(root.searchedTagValue);
          root.saveFingerPrintCheck = true;
          $(function () {
            $('input[name="fpStartDate"]').daterangepicker({
              singleDatePicker: true,
              showDropdowns: true,
              timePicker: true,
              timePicker24Hour: true,
              maxDate: moment.utc(),
              startDate: moment.utc(),
              maxYear: parseInt(moment.utc().format('YYYY'), 10),
              locale: {
                format: 'YYYY-MM-DD HH:mm',
                "applyLabel": "Confirm Dates",
              },
            }, function (start, end, label) {

              root.fingerprintstartDate = start.format('YYYY-MM-DD HH:mm:ss');
            });
          });
        }
      },
      _showTimestamp: function (date) {
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
          "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"
        ];
        if (date) {
          var dateTime = new Date(date);
          var Month = monthNames[dateTime.getMonth()];
          // var day = format(endTime.getDate());
          var Year = (dateTime.getFullYear().toString().substr(-2));
          return Month + "-" + Year;
        }
        else {
          return '-'
        }

      },
      _openList: function (e) {
        root.this;
        if (e.currentTarget.value) {
          var tagList = root.tagDataList;
          var inputTag = e.target.value.toLowerCase();
          var filteredTag = tagList.filter(function (arr, key) {
            return (
              arr.tag_id.toLowerCase().indexOf(inputTag) != -1 ||
              (arr.description ? arr.description.toLowerCase().indexOf(inputTag) != -1 : '')
            );
          });
          var searchResultID = "searchResult_" + e.currentTarget.id;
          document.getElementById(searchResultID).style.display = "block";
          root.tagSearchResult = filteredTag;
        }
        else { root.tagSearchResult = false; }
      },
      _addCondition: function () {
        if (root.addConditionalTags.length < 2) {
          this.push("addConditionalTags", Math.round(new Date().valueOf() * Math.random()));
        }
        document.querySelector('#performSimilaritySearch').disabled = false;
      },
      _removeCondition: function (e) {

        root = this;
        var tagname = e.currentTarget.dataset.seriesname;
        var tagID = (e.currentTarget.id).split('tag')[1];



        if (root.addConditionalTags.length > 0) {
          var index = this.addConditionalTags.findIndex(function (item) {
            return item == e.target.id
          });
          this.splice('addConditionalTags', index, 1);

          var index = root.selectedTagList.indexOf(((window.organization_id + '_' + tagname).toUpperCase()));


          if (tagname) {
            root.selectedTagList.splice(index, 1);
            var chart = $("#container").highcharts();
            if (chart.get(tagname))
              chart.get(tagname).remove();
          }
        } else {
          root.addConditionalTags = [];
        }
        root.similaritySearchResult = false;
        document.querySelector('#performSimilaritySearch').disabled = false;
      },
      _GMTtimeConverter: function (UNIX_timestamp) {
        var a = new Date(UNIX_timestamp);
        var year = a.getFullYear();
        var month = a.getMonth() + 1;
        var date = a.getDate();
        var hour = a.getHours();
        var min = a.getMinutes();
        var sec = a.getSeconds();
        var time = year + '-' + month + '-' + date + ' ' + hour + ':' + min + ':' + ":0";
        return time;
      },
      _timezoneConverter: function (UNIX_timestamp) {
        var a = new Date(UNIX_timestamp);
        var date = a.getUTCDate();
        var month = a.getUTCMonth() + 1;
        var year = a.getUTCFullYear();
        var hour = a.getUTCHours();
        var min = a.getUTCMinutes();
        var time =
          year + "-" + month + "-" + date + " " + hour + ":" + min + ":0";
        return time;
      },
      _matchPercentage: function (value) {
        var match = value * 100;
        return Number.parseFloat(match).toPrecision(4);
      },
      _getTrends: function (tag) {
        root = this;
        if (root.timeCoverterCheck) {
          var end = root.endDateRange;
          var start = root.startDateRange;
          root.startDateRange = start;
          root.endDateRange = end;
          root.searchStartDateRange = root.startDateRange;
          root.searchEndDateRange = end;
          root.$.e_getTagTrends.url =
            "/getTagTrends/" +
            tag +
            "/" +
            start +
            "/" +
            end;
          root.$.e_getTagTrends.generateRequest();
          root.criteriaStartDateRange = start;
          root.criteriaEndDateRange = end;

        }
        else {
          var end = root.endDateRange;
          var start = root.startDateRange;
          root.startDateRange = start;
          root.endDateRange = end;
          root.searchStartDateRange = this._timezoneConverter(start);
          root.searchEndDateRange = this._timezoneConverter(end);
          root.$.e_getTagTrends.url =
            "/getTagTrends/" +
            tag +
            "/" +
            this._timezoneConverter(start) +
            "/" +
            this._timezoneConverter(end);
          root.$.e_getTagTrends.generateRequest();
          root.criteriaStartDateRange = this._timezoneConverter(start);
          root.criteriaEndDateRange = this._timezoneConverter(end);
        }
      },
      _addTag: function (e) {
        var root = this;
        root.tagSearchResult = false;
        root.legends = [];
        root.selectedTagList = [];
        root.dataPattern = [];
        root.searchedTagValue = e.currentTarget.dataset.tagselected;
        // root.selectedTagList.push(e.currentTarget.dataset.tagselected);
        root.searchedTagNameValue = e.currentTarget.dataset.tagname;
      },
      _tagSelected: function (e) {
        root = this;
        var mapwith = e.currentTarget.parentNode.parentNode.parentNode.childNodes[1].id;
        document.getElementById(mapwith).value = e.currentTarget.dataset.tagname;
        e.currentTarget.parentNode.parentNode.parentNode.parentNode.childNodes[3].dataset.seriesname = e.currentTarget.dataset.tagname;

        root.tagSearchResult = false;
        e.target.parentNode.parentNode.parentNode.style.display = "none";

        if (root.selectedTagList.indexOf(e.currentTarget.dataset.tagselected) == -1) {
          root.showSimilarityCheck = false;
          document.getElementById(mapwith).readOnly = true;
          root.selectedTagList.push(e.currentTarget.dataset.tagselected);
          root._getTrends(e.currentTarget.dataset.tagselected);
          root.trendTagCheck = true;
          var chart = $("#container").highcharts();
          chart.xAxis[0].removePlotBand("plot-band");
        }
      },
      _backtoTrends: function () {
        root = this;
        root.selectedTagList = [];
        root.saveFingerPrintCheck = false;
        root.$.trendCheck.style.display = "block";
        root.similarityCheck = false;
        root.similaritySearchResult = false;
        root.trendTagCheck = false;
        root.addConditionalTags = [];
        root.addCondTags = [];
        root.selectedDateRange = [];
        root.dataPattern = [];

        var chart = $("#container").highcharts();
        if (chart) {
          while (chart.series.length > 0) chart.series[0].remove(true);
          Highcharts.stockChart("container", {
            navigator: {
              enabled: true,
              height: 60
            },
            rangeSelector: {
              inputEnabled: false,
              enabled: false
            }
          });
        }
        root.showSimilarityCheck = false;

        var test = $('#fingerPrintForm').collapse('hide');
      },
      _getRandomRolor: function (str) {
        let i = 0, hash = 0;
        for (i = 0, hash = 0; i < str.length; hash = str.charCodeAt(i++) + ((hash << 5) - hash));
        const color = Math.floor(Math.abs((Math.sin(hash) * 10000) % 1 * 16777216)).toString(16);
        return '#' + new Array(6 - color.length + 1).join('0') + color;
      },
      _onResponse_getTagTrends: function (e) {
        root = this;

        var newlist;
        var data2 = [];
        var result = [];
        if (!root.showSimilarityCheck) {
          root.seriesData = e.detail.response.data;
        }
        if (root.showSimilarityCheck) {
          result = e.detail.response;
          newlist = result.data;
          if (newlist) {
            for (i = 0; i < newlist.length; i++) {
              data2.push([newlist[i][0] + root.delta, newlist[i][1]]);
            }
            var legendName = e.detail.url.split('/getTagTrends/')[1].split('/')[0].slice(window.organization_id.length + 1) + ' - ' +
              root._timezoneConverter(root.startTimestamp) + " - (" + root.similarityMatch + "% " + root.matchType + ")";
            root.colorCode = this._getRandomRolor(legendName);
            if (root.legends.indexOf(legendName) == -1) {
              root.legends.push(legendName);
              var chart = $("#container").highcharts();
              var series = {
                color: root.colorCode,
                name: legendName,
                data: data2,
                showInNavigator: true,
                zoneAxis: "x",
                zones: [
                  {
                    value: 8
                  },
                  {
                    dashStyle: "dot"
                  }
                ]
              };
              chart.addSeries(series, true);
            }
          } else {
            root.trendAlerts = true;
            root.trendAlerts = result.status;
            root.async(function () {
              root.trendAlerts = false;
            }, 5000);
          }
        }

        if (e.detail.response.data && root.showSimilarityCheck == false) {
          if (root.trendTagCheck) {
            var chart = $("#container").highcharts();
            root.colorCode = this._getRandomRolor(e.detail.url.split('/getTagTrends/')[1].split('/')[0].slice(window.organization_id.length + 1));
            var series = {
              id: e.detail.url.split('/getTagTrends/')[1].split('/')[0].slice(window.organization_id.length + 1),
              color: root.colorCode,
              name: e.detail.url.split('/getTagTrends/')[1].split('/')[0].slice(window.organization_id.length + 1),
              data: e.detail.response.data,
              showInNavigator: true,
              zoneAxis: "x",
              zones: [
                {
                  value: 8
                },
                {
                  dashStyle: "solid"
                }
              ]
            };
            chart.addSeries(series, true);
          }
          else {
            root._getVisulization();
          }
        } else {
          root.trendAlerts = e.detail.response.status;
          this.async(function () {
            root.trendAlerts = false;
          }, 5000);
        }
      },
      _getVisulization: function () {
        root = this;
        $(function () {
          $('input[name="searchRange"]').daterangepicker(
            {
              timePicker: true,
              showDropdowns: true,
              timePicker24Hour: true,
              timePickerSeconds: false,
              alwaysShowCalendars: true,
              maxDate: moment.utc().startOf("minutes"),
              opens: "right",
              ranges: {
                Today: [moment.utc(), moment.utc()],
                Yesterday: [
                  moment.utc().subtract(1, "days"),
                  moment.utc().subtract(1, "days")
                ],
                "Last 7 Days": [moment.utc().subtract(6, "days"), moment.utc()],
                "Last 30 Days": [moment.utc().subtract(29, "days"), moment.utc()],
                "This Month": [
                  moment.utc().startOf("month"),
                  moment.utc().endOf("month")
                ],
                "Last Month": [
                  moment.utc()
                    .subtract(1, "month")
                    .startOf("month"),
                  moment.utc()
                    .subtract(1, "month")
                    .endOf("month")
                ]
              },
              startDate: root.searchStartDateRange,
              endDate: root.searchEndDateRange,
              locale: {
                format: "YYYY-MM-DD HH:mm",
                "applyLabel": "Confirm Dates",
              }
            },
            function (start, end, label) {
              root.searchStartDateRange = start.format("YYYY-MM-DD HH:mm:ss");
              root.searchEndDateRange = end.format("YYYY-MM-DD HH:mm:ss");
              document.querySelector('#performSimilaritySearch').disabled = false;
            }
          );
        });
        root.$.trendCheck.style.display = "none";
        root.similarityCheck = true;
        var seriesData = root.seriesData;
        Highcharts.Chart.prototype.unselectAll = function () {
          for (var i = 0; i < this.series[0].data.length; i++) {
            root.selectedDateRange = [];
            root.dataPattern = [];
          }
        };
        function unselectByClick() {
          if (this.series[0])
            for (var i = 0; i < this.series[0].data.length; i++) {
              root.selectedDateRange = [];
              root.dataPattern = [];
            }
        }

        var chart = new Highcharts.Chart({
          chart: {
            renderTo: "container",
            events: {
              click: unselectByClick,
              selection: function (e) {
                var dataPoints = [];
                root.dataPattern = [];
                root.selectedDateRange = []
                chart.xAxis[0].removePlotBand("plot-band");
                document.querySelector('#performSimilaritySearch').disabled = false;
                root.highchartTrends = this.series;
                Highcharts.each(this.series, function (series) {
                  if (!series.name.includes('Navigator ')) {
                    Highcharts.each(series.points, function (point) {
                      if (point.x >= e.xAxis[0].min && point.x <= e.xAxis[0].max) {
                        if (point.y != null) {
                          dataPoints.push([point.x, point.y]);
                          root.selectedDateRange.push(point.x);
                          root.dataPattern.push(point.y);
                          if (dataPoints[0][0]) {
                            chart.xAxis[0].addPlotBand({
                              from: dataPoints[0][0],
                              to: dataPoints[dataPoints.length - 1][0],
                              color: "#F0F0C0",
                              id: "plot-band"
                            });
                          }
                        }
                        else {
                          chart.xAxis[0].removePlotBand("plot-band");
                          root.dataPattern = [];
                          document.querySelector('#performSimilaritySearch').disabled = true;
                          root.trendAlerts = "Please select a Data Pattern with non null values";
                          root.async(function () {
                            root.trendAlerts = false;

                          }, 5000);
                        }
                      }
                    });
                  }
                });
                if (root.dataPattern.length > 3000) {
                  root.dataPattern = [];
                  chart.xAxis[0].removePlotBand("plot-band");
                  root.trendAlerts = 'Select a smaller DataSet';
                  root.async(function () {
                    root.trendAlerts = false;
                  }, 5000);
                }
                return false; // Don't zoom

              }
            },
            zoomType: "x"
          },
          boost: {
            useGPUTranslations: true
          },
          xAxis: [
            {
              gridLineWidth: 1,
              gridLineDashStyle: "solid",
              type: "datetime"
            },
            {
              type: "datetime",
              visible: false
            }
          ],
          yAxis: [
            {
              gridLineWidth: 0,
              gridLineDashStyle: "solid",
              title: {
                text: ""
              }
            }
          ],
          plotOptions: {
            line: {
              marker: {
                enabled: true,
                radius: 0,
                borderWidth: 0
              }
            }
          },
          rangeSelector: {
            enabled: true,
            selected: 1,
            inputEnabled: true,
            inputPosition: {
              x: -30
            },
            buttonPosition: {
              align: "left"
            },
            // labelStyle: {
            //   display: "none"
            // },
            buttons: [
              {
                type: "hour",
                count: 0,
                text: "1h"
              },
              {
                type: "day",
                count: 0,
                text: "1d"
              },
              {
                type: "week",
                count: 0,
                text: "1w"
              },
              {
                type: "month",
                count: 1,
                text: "1m"
              },
              {
                type: "month",
                count: 3,
                text: "3m"
              },
              {
                type: "month",
                count: 6,
                text: "6m"
              },
              {
                type: "ytd",
                text: "YTD"
              },
              {
                type: "year",
                count: 1,
                text: "1y"
              },
              {
                type: "all",
                text: "All"
              }
            ]
          },
          legend: {
            enabled: true,
            allButtonsEnabled: true,
            borderColor: "#ced4da",
            borderRadius: "5px",
            borderWidth: 1,
            labelFormatter: function () {
              return (
                '<span style="fill: ' +
                this.color +
                '">' +
                this.name +
                "</span>"
              );
            },
            symbolPadding: 0,
            symbolWidth: 0,
            symbolRadius: 0
          },
          title: {
            text: null,
            enabled: false
          },
          tooltip: {
            xDateFormat: '%Y-%m-%d %H:%M',
            shared: true
          },
          navigator: {
            enabled: true,
            height: 60,
            xAxis: {},
            buttonOptions: {
              enabled: true
            },
          },
          series: [
            {
              name: root.searchedTagNameValue,
              data: seriesData,
              showInNavigator: true,
              dataGrouping: {
                enabled: false
              }
            }
          ]
        }, function (chart) {
          var i = 0;
          chart.renderer.button('reset', 50, 50)
            .attr({
              zIndex: 3
            })
            .on('click', function () {
              while (chart.series.length > 0) chart.series[0].remove(true);
              root.dataPattern = [];
              root.selectedDateRange = [];
              root.showSimilarityCheck = false;
              root.similaritySearchResult = false;
              root.legends = [];
              document.querySelector('#performSimilaritySearch').disabled = false;
              chart.xAxis[0].removePlotBand("plot-band");
              chart.redraw()

              for (var i = 0; i < root.selectedTagList.length; i++) {
                root._getTrends(root.selectedTagList[i]);
              }
            })
            .add();
        }
        );

      },
      _onResponse_searchTag: function (e) {
        var root = this;
        var tagList = e.detail.response;
        root.$.searchedTag.addEventListener("input", function (e) {
          var inputTag = e.currentTarget.value.toLowerCase();
          if (inputTag) {
            var filteredTag = tagList.filter(function (arr, key) {
              return (
                arr.tag_id.toLowerCase().indexOf(inputTag) != -1 ||
                (arr.description ? arr.description.toLowerCase().indexOf(inputTag) != -1 : '')
              );
            });
            root.tagSearchResult = filteredTag;
          } else {
            root.tagSearchResult = false;
          }
        });
      },
      splitDataPattern: function (selectedPatternArray, chunk_size) {
        if (chunk_size > 1) {
          var index = 0;
          var arrayLength = selectedPatternArray.length;
          var chunks = selectedPatternArray.length / chunk_size
          let results = [];

          while (selectedPatternArray.length) {
            results.push(selectedPatternArray.splice(0, chunks))
          }

          return results;
        }
        else {
          return selectedPatternArray;
        }
      },
      _performSimilaritySearch: function () {
        root = this;

        var inputs = document.querySelector('#similarityBasedSearchForm').elements
        if (root.$$("#similarityBasedSearchForm").checkValidity()) {
          if (root.dataPattern.length > 1) {
            var patternList = [];
            var data = [];
            var chartTagList = [];
            var similarityPercentageValue;
            for (var i = 0; i < inputs.length; i++) {
              if (inputs[i].name == 'similarityPercentage') {
                similarityPercentageValue = inputs[i].value;
              }
            }


            var similarityPercentage = Number(similarityPercentageValue) / 100;
            var similarityType = document.querySelector("#similarityType").value.toLowerCase();
            var patternArray = root.dataPattern;
            var tagLength = root.selectedTagList.length;
            var chart = $('#container').highcharts();
            for (var i = 0; i < chart.series.length; i++) {
              if (!chart.series[i].name.includes('Navigator ')) {
                chartTagList.push(chart.series[i].name);
              }
              //  chart.series[0].remove(true);
            }
            patternList = root.splitDataPattern(patternArray, tagLength);
            if (tagLength > 1) {
              for (var i = 0; i < chartTagList.length; i++) {
                data.push({
                  tagId: window.organization_id.toUpperCase() + '_' + chartTagList[i],
                  pattern: patternList[i]
                });
              }
            }
            else {
              data.push({
                tagId: root.selectedTagList[0],
                pattern: patternList
              });
            }
            root.$.e_similaritySearch.body = data;
            root.patternTimespanStart = root.startDateRange;
            root.patternTimespanEnd = root.endDateRange;
            // root.startDate = root._timezoneConverter(root.searchStartDateRange);
            root.startDate = root.searchStartDateRange;
            root.endDate = root.searchEndDateRange;
            root.tagId = root.searchedTagValue;
            root.threshold = similarityPercentage;
            root.similarityType = similarityType.toLowerCase();
            root.$.e_similaritySearch.generateRequest();
          } else {
            root.trendAlerts = true;
            root.trendAlerts = "Please select a Data Pattern";
            var chart = $("#container").highcharts();
            chart.xAxis[0].removePlotBand("plot-band");
            this.async(function () {
              root.trendAlerts = false;
            }, 5000);
          }
        }
      },
      _onResponse_similaritySearch: function (e) {
        root.result = e.detail.response;
        if (root.result.status) {
          root.trendAlerts = true;
          root.trendAlerts = root.result.status;
          root.similaritySearchResult = false;
          root.async(function () {
            root.trendAlerts = false;
          }, 5000);
        } else {
          document.querySelector('#performSimilaritySearch').disabled = true;
          root.similaritySearchResult = root.result.slice(0, 200);
          root.totalRecords = root.similaritySearchResult.length;
        }
      },
      _showSimilarity: function (e) {
        root = this;
        root.similarityMatch = e.currentTarget.dataset.similarmatch;
        var startTimestamp = e.currentTarget.dataset.similaritytimestamp;
        startTimestamp = Number(startTimestamp);
        root.startTimestamp = startTimestamp;
        var backOverlayTimeStamp, frontOverlayTimeStamp, newlist;
        var deltaBackOverlay = root.selectedDateRange[0] - root.seriesData[0][0];
        var deltaFrontOverlay = root.seriesData[root.seriesData.length - 1][0] - root.selectedDateRange[0];
        var delta = root.selectedDateRange[0] - startTimestamp;
        root.delta = delta;
        backOverlayTimeStamp = startTimestamp - deltaBackOverlay;
        frontOverlayTimeStamp = startTimestamp + deltaFrontOverlay + (root.dataPattern.length * 60000);
        root.fpfrontOverlayTimeStamp = frontOverlayTimeStamp;
        root.fpbackOverlayTimeStamp = backOverlayTimeStamp;
        if (backOverlayTimeStamp && frontOverlayTimeStamp) {
          for (var item = 0; item < root.selectedTagList.length; item++) {
            e.target.parentNode.parentNode.style.borderLeft = "3px solid #cccccc";
            root.showSimilarityCheck = true;
            root.$.e_getTagTrends.url = "/getTagTrends/" + root.selectedTagList[item] + "/" + this._timezoneConverter(backOverlayTimeStamp) + "/" + this._timezoneConverter(frontOverlayTimeStamp);
            root.$.e_getTagTrends.generateRequest();
            root.fingerPrintAreaPatternList.push({
              "tag_id": root.selectedTagList[item],
              "startDate": backOverlayTimeStamp,
              "endDate": frontOverlayTimeStamp
            })
          }
          $('#fingerPrintForm').collapse('hide');
        }
      },
      _selectionChanged: function (e) {
        root = this;
        root.legends = [];
        root.matchType = document.querySelector("#similarityType").value;
        root.similaritySearchResult = false;
        document.querySelector('#performSimilaritySearch').disabled = false;
      },
      //finger print functions
      _addfpNotificaiton: function () {
        root = this;
        if (root.fpNotificaiton) {
          root.fpNotificaiton = false;
        }
        else {
          root.fpNotificaiton = true;
        }

      },
      _createAreaRangeData: function (datax) {
        var max = Math.min.apply(Math, datax.map(function (a) {
          return a.length;
        }));
        var arrFinal = [];

        for (let i = 0; i < max; i++) {
          var arr = [];
          for (let j = 0; j < datax.length; j++) {
            var dataj = datax[j];
            arr.push(dataj[i]);
          }

          var vals = [];
          for (let k = 0; k < datax.length; k++) {
            var valk = arr[k];
            if (valk) {
              vals.push(valk[1]);
            } else {
              vals.push(null);
            }
          }
          var min_v = Math.min.apply(Math, vals);
          var max_v = Math.max.apply(Math, vals);
          arrFinal.push([arr[0][0], min_v, max_v]);
        }
        return arrFinal;
      },
      _markArea: function (data) {
        var root = this;
        var chart = $('#container').highcharts();
        var datax = data;
        var found = false;
        chart.series.forEach(function (e, i) {
          if (e.name === 'markedArea') {
            found = true;
            chart.series[i].update({
              data: root._createAreaRangeData(datax), name: 'markedArea', color: '#9c9a9a', plotOptions: {
                series: {
                  colorByPoint: true
                }
              }
            }, true);
          }
        });

        if (!found) {
          chart.addSeries({
            data: root._createAreaRangeData(datax), type: 'arearange', name: 'markedArea', color: '#9c9a9a', plotOptions: {
              series: {
                colorByPoint: true
              }
            }
          }, true);
        }
      },
      _openFingerPrint: function (e) {
        $('#fingerPrintForm').collapse('show');
        document.querySelector('#similarityBasedSearchForm').style.display = 'none';

        // root.fpfrontOverlayTimeStamp;
        // root.fpbackOverlayTimeStamp;
        var chart = $('#container').highcharts();
        chart.series.forEach(function (e, i) {
          if (e.name === 'markedArea') {
            chart.series[i].remove();
          }
        });
        root.similaritySearchResult = false;
        var type = e.currentTarget.dataset.type;
        var series = root.highchartTrends;
        var fingerPrintSeries = [];
        if (series.length) {
          for (x = 0; x < series.length; x++) {
            if (!series[x].name.includes('Navigator ')) {
              var seriesData = [];
              if (series[x]) {
                for (var y = 0; y < series[x].data.length; y++) {
                  seriesData.push([series[x].xData[y], series[x].yData[y]]);
                }
              }
              else {
              }
              fingerPrintSeries.push(seriesData);
            }
          }
          root._markArea(fingerPrintSeries);
        }
      },
      _saveFingerPrint: function (e) {
        root = this;
        var series = root.highchartTrends;
        var seriesNameList = [];
        var seriesData = [];
        var fingerPrintAreaPatternList = [];
        var patternStartTimeStamp = root.selectedDateRange[0];
        var patternEndTimeStamp = root.selectedDateRange[root.selectedDateRange.length - 1];
        for (x = 0; x < series.length; x++) {
          if (!series[x].name.includes('Navigator ') && !series[x].name.includes('markedArea')) {
            var seriesData = [];
            if (series[x]) {
              for (var y = 0; y < series[x].xData.length; y++) {
                if (patternStartTimeStamp <= series[x].xData[y] && patternEndTimeStamp >= series[x].xData[y]) {
                  seriesData.push(series[x].yData[y]);
                }
              }
              seriesNameList.push(series[x].name)
            }
            else {
            }
            fingerPrintAreaPatternList.push(seriesData);

          }
        }
        var seriesAreaPattern = {}
        for (var i = 0; i < fingerPrintAreaPatternList.length; i++) {
          seriesAreaPattern['overlay' + (i + 1)] = fingerPrintAreaPatternList[i];
        }
        // seriesAreaPattern['seriesNames'] = seriesNameList;
        // seriesAreaPattern['overlaySeriesDetail'] = root.fingerPrintAreaPatternList;

        var intervalDifference = (root.selectedDateRange[1] - root.selectedDateRange[0]) / 60000;
        var overlay = document.documentElement;
        if (root.$$('#fingerPrintForm').checkValidity()) {
          if (fingerPrintAreaPatternList.length > 1) {
            var bodyData = {}
            bodyData['tag_id'] = root.searchedTagValue;
            bodyData['user_id'] = window.user_id;
            bodyData["fp_type"] = "area_search";
            bodyData['fp_name'] = root.$.fpName.value;
            bodyData['description'] = root.$.description.value;
            bodyData['pattern_values'] = seriesAreaPattern;
            bodyData['pattern_start_date'] = root._timezoneConverter(root.selectedDateRange[0]);
            bodyData['pattern_end_date'] = root._timezoneConverter(root.selectedDateRange[root.selectedDateRange.length - 1]);
            bodyData['timespan_start_date'] = root.fpStartDateRange;
            bodyData['timespan_end_date'] = root.fpEndDateRange;
            bodyData['start_date'] = root.fingerprintstartDate;
            bodyData['insertion_date'] = root._timezoneConverter(new Date());
            bodyData['status'] = root.$.addfingerprinttatus.checked;
            bodyData['execution_interval'] = intervalDifference;
            bodyData['threshold'] = Number(root.$.similarityPercentage.value) / 100;
            bodyData['priority'] = root.$.similarityPriority.value.toLowerCase();
            if (root.$.addfpNotificaiton.checked)
              bodyData["email_status"] = root.$.addfpNotificaiton.checked;
            else {
              bodyData["email_status"] = root.$.addfpNotificaiton.checked = false;
            }
            if (root.$.addfpNotificaiton.checked) {
              bodyData["email"] = document.getElementById('addEmail').value;
            }
            else {
              bodyData["email"] = null;
            }
            root.$.e_createFingerPrint.body = JSON.stringify(bodyData);
            root.$.e_createFingerPrint.generateRequest();
          }
          else {
            root.trendAlerts = true;
            root.trendAlerts = 'Not enough data patterns for the action';
            this.async(function () {
              root.trendAlerts = false;
            }, 5000);
          }
        }
      },
      _onResponse_createFingerPrint: function (e) {
        $('#fingerPrintForm').collapse('hide');
        document.querySelector('#similarityBasedSearchForm').style.display = 'block'
        var response = e.detail.response
        if (response.status) {
          root.trendAlerts = true;
          root.trendAlerts = response.status;
          this.async(function () {
            root.trendAlerts = false;
          }, 5000);
        }
      },
      _cancelFingerPrint: function () {
        var root = this;
        document.querySelector('#similarityBasedSearchForm').style.display = 'block'
        root.similaritySearchResult = root.e_similaritySearchResults;
        var chart = $('#container').highcharts();
        chart.series.forEach(function (e, i) {
          if (e.name === 'markedArea') {
            chart.series[i].remove();
          }
        });
        document.querySelector('#performSimilaritySearch').disabled = false;
        $('#fingerPrintForm').collapse('hide');
      },
      _dismissAlert: function () {
        root = this;
        root.trendAlerts = false;
      },
    });
  </script>
</dom-module>