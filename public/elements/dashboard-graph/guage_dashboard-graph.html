<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<!-- <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script> -->
<script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
<link rel="import" href="../global-loader/global-loader.html">

<dom-module id="dashboard-graph">

    <template>

        <global-loader>
            <iron-ajax id="getTagTrends"
                url$="/getTagTrends/{{graphTag}}/{{_timezoneConverter(start)}}/{{_timezoneConverter(end)}}"
                on-response="_onResponse_getTagTrends"></iron-ajax>
        </global-loader>

        <global-loader>
            <iron-ajax id="removeFromUserDashboard" url$="/removeFromUserDashboard/{{graphDashboardId}}"
                on-response="_onResponse_removeFromUserDashboard">
            </iron-ajax>
        </global-loader>

        <global-loader>
            <iron-ajax id="updateUserDashboard" method="POST" url="/updateUserDashboard"
                headers='{"Content-Type": "application/json"}' on-response="_onResponse_updateUserDashboard">
            </iron-ajax>
        </global-loader>

        <style>
            .graph-wrapper {
                position: relative;
            }

            .graph-controls {
                display: none;
            }

            .graph-wrapper:hover .graph-controls,
            .graph-wrapper:hover .graph-controls {
                display: block;
                position: absolute;
                top: 25px;
                right: 25px;
            }

            .graph-header .h4 {
                word-break: break-all !important;
            }
        </style>


        <div class="graph-wrapper p-3">
            <div class="graph-controls">
                <a href="javascript:void(0)" data-toggle="modal" data-target$="#deleteGraph{{uid}}" title="Delete"
                    class="mx-1"><i class="fas fa-trash-alt text-danger"></i></a>
                <a href="javascript:void(0)" data-toggle="modal" data-target$="#editGraph{{uid}}" title="Edit"
                    class="mx-1"><i class="fas fa-cog text-dark"></i></a>
                <a href="javascript:void(0)" data-toggle="modal" data-target$="#deleteGraph{{uid}}" title="Move"
                    class="mx-1 handle"><i class="fas fa-arrows-alt text-dark"></i></a>
            </div>


            <div class$="{{graphClasses}}" style="min-height: 225px">

                <template is="dom-if" if="{{chartReady}}">

                    <div class="graph-header pt-2 pl-3">
                        <div class="h4 font-weight-light text-muted m-0">{{graphName}}</div>

                        <h3>
                            <template is="dom-if" if="{{graphCurrentValue}}"><span>{{graphLastValue}}</span></template>
                            <template is="dom-if" if="{{graphUnit}}"><small class="h6 font-weight-normal"
                                    style="vertical-align: super;">{{graphUnit}}</small></template>
                        </h3>
                        <template is="dom-if" if="{{!graphCurrentValue}}">
                            <div style="height: 45px;"></div>
                        </template>

                    </div>

                </template>
                <div id="graph" style="width: 200px;height:200px;"></div>

                <template is="dom-if" if="{{graphMessage}}">
                    <div class="text-muted text-center p-5 align-items-center d-flex">{{graphMessage}}</div>
                </template>
            </div>



            <!-- Modal -->
            <div class="modal" id$="deleteGraph{{uid}}" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addToDashboardTitle">Delete graph</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">

                            <p>You want to delete {{graphName}}?</p>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" on-click="_deleteGraph">Delete</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Modal -->
            <div class="modal" id$="editGraph{{uid}}" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addToDashboardTitle">Edit graph</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="col-md-10 form-group">
                                    <label for$="tagName{{uid}}">Select tag</label>
                                    <input id$="tagName{{uid}}" class="form-control" placeholder="Tag id"
                                        autocomplete="off" value="{{graphName}}" disabled>
                                </div>
                                <div class="col-md-2 form-group">
                                    <label for$="tagUnit{{uid}}">Unit</label>
                                    <input id$="tagUnit{{uid}}" type="text" class="form-control" id="unit"
                                        autocomplete="off" value="{{graphUnit}}">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="col-md-6 form-group">
                                    <label for$="graphPeriod{{uid}}">Time period</label>
                                    <select id$="graphPeriod{{uid}}" class="form-control" autocomplete="off">
                                        <option value="8" selected$="{{_markSelected(graphDuration, 8)}}">8 hours
                                        </option>
                                        <option value="24" selected$="{{_markSelected(graphDuration, 24)}}">24 hours
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-6 form-group">
                                    <label for$="optimumValue{{uid}}">Optimum value</label>
                                    <input type="text" class="form-control" id$="optimumValue{{uid}}" autocomplete="off"
                                        value="{{graphOptimumValue}}">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="col-md-6 form-group">
                                    <label for$="alarmMinValue{{uid}}">Min threshold</label>
                                    <input type="text" class="form-control" id$="alarmMinValue{{uid}}"
                                        autocomplete="off" value="{{graphAlarmMinValue}}">
                                </div>
                                <div class="col-md-6 form-group">
                                    <label for$="alarmMaxValue{{uid}}">Max threshold</label>
                                    <input type="text" class="form-control" id$="alarmMaxValue{{uid}}"
                                        autocomplete="off" value="{{graphAlarmMaxValue}}">
                                </div>
                            </div>

                            <div class="custom-control custom-checkbox my-1 mr-sm-2">
                                <input type="checkbox" class="custom-control-input" id$="currentValue{{uid}}"
                                    checked="{{graphCurrentValue}}">
                                <label class="custom-control-label" for$="currentValue{{uid}}">Show current
                                    value</label>
                            </div>


                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" on-click="_editGraph">Save changes</button>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </template>

    <script>
        Polymer({
            is: "dashboard-graph",

            properties: {
                uid: {
                    notify: true,
                    computed: '_uid(graphName)'
                },
                chartReady: {
                    value: false
                }
            },

            created: function () {
            },

            ready: function () {
            },

            attached: function () {
                var _root = this;

                if (this.graphDate) {
                    this.end = new Date(this.graphDate);
                    this.start = moment(new Date(this.graphDate)).subtract(this.graphDuration, "hours").toDate();
                    this.$.getTagTrends.generateRequest();
                }
                else {
                    _root.graphMessage = "This Tag: " + _root.graphTag + " does not have data";
                    _root.graphClasses = 'bg-white border graph-container overflow-hidden rounded shadow-sm';
                }
            },

            detached: function () {
            },

            attributeChanged: function (name, type) {
            },

            _uid: function (graphName) {
                return '_' + Math.random().toString(36).substr(2, 9);
            },

            _getRandomRolor: function () {

                var hexValues = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e"];
                var newColor = "#";

                for (var i = 0; i < 3; i++) {
                    var x = Math.round(Math.random() * 14);
                    newColor += hexValues[x];
                }
                return newColor;
            },
            _timezoneConverter: function (UNIX_timestamp) {
                var a = new Date(UNIX_timestamp);
                var year = a.getFullYear();
                var month = a.getMonth() + 1;
                var date = a.getDate();
                var hour = a.getHours();
                var min = a.getMinutes();
                var sec = a.getSeconds();
                var time = year + '-' + month + '-' + date + ' ' + hour + ':' + min + ':' + sec;
                return time;
            },
            _onResponse_getTagTrends: function (e) {
                var _root = this;
                _root._data = e.detail.response.data;
                var _color = _root._getRandomRolor();

                _root.graphClasses = 'bg-white border graph-container overflow-hidden rounded shadow-sm';

                // if (!_root._data) {
                //     _root.graphMessage = e.detail.response.status;
                //     //_root.parentElement.remove();
                //     return;
                // }

                _root.graphLastValue = _root._data ? _root._data.slice(-1)[0][1] : '';

                var gaugeOptions = {


                };

                // The speed gauge
                var chartSpeed = Highcharts.chart(_root.$.graph, {
                    chart: {
                        type: 'solidgauge',
                        background: 'red'
                    },

                    title: null,

                    pane: {
                        center: ['50%', '85%'],
                        size: '190px',
                        startAngle: -90,
                        endAngle: 90,
                        background: {
                            backgroundColor: '#EEE',
                            innerRadius: '60%',
                            outerRadius: '100%',
                            shape: 'arc',
                        }
                    },

                    tooltip: {
                        enabled: false
                    },

                    // the value axis
                    yAxis: {
                        min: 0,
                        max: 100,
                        stops: [
                            [0.1, '#55BF3B'], // green
                            [0.5, '#DDDF0D'], // yellow
                            [0.9, '#DF5353'] // red
                        ],
                        lineWidth: 0,
                        minorTickInterval: null,
                        tickAmount: 2,
                        title: {
                            y: -70
                        },
                        labels: {
                            y: 16
                        }
                    },

                    plotOptions: {
                        solidgauge: {
                            dataLabels: {
                                y: 5,
                                borderWidth: 0,
                                useHTML: true
                            }
                        }
                    },

                    credits: {
                        enabled: false
                    },

                    series: [{
                        name: 'Speed',
                        data: [80],
                        dataLabels: {
                            format:
                                '<div style="text-align:center">' +
                                '<span style="font-size:20px">{y}</span><br/>' +
                                '<span style="font-size:12px;opacity:0.4">km/h</span>' +
                                '</div>'
                        },
                        tooltip: {
                            valueSuffix: ' km/h'
                        }
                    }]

                });









                // _root.hightStockChart = new Highcharts.stockChart({
                //     chart: {
                //         renderTo: _root.$.graph,
                //         backgroundColor: 'transparent',
                //         height: (9 / 27 * 100) + '%',
                //         spacingTop: 20,
                //         spacingBottom: 20,
                //         spacingLeft: 0,
                //         spacingRight: 0,
                //         /* style: {
                //             fontFamily: 'serif'
                //         } */
                //     },
                //     title: {
                //         enabled: false
                //     },
                //     navigator: {
                //         enabled: false
                //     },
                //     navigation: {
                //         buttonOptions: {
                //             enabled: false
                //         }
                //     },
                //     rangeSelector: {
                //         enabled: false
                //     },
                //     scrollbar: {
                //         enabled: false
                //     },
                //     series: [{
                //         type: 'spline',
                //         name: 'Value',
                //         data: _root._data,
                //         lineColor: _color,
                //         lineWidth: 1,
                //         tooltip: {
                //             valueDecimals: 2,
                //             valuePrefix: '',
                //             valueSuffix: ' ' + (_root.graphUnit ? _root.graphUnit : '')
                //         },
                //         states: {
                //             hover: {
                //                 halo: {
                //                     size: 9,
                //                     attributes: {
                //                         fill: 'transparent',
                //                         'stroke-width': 1,
                //                         stroke: '#333'
                //                     }
                //                 }

                //             }
                //         }
                //     }],
                //     xAxis: {
                //         visible: false,
                //         labels: {
                //             enabled: false
                //         }
                //     },
                //     yAxis: {
                //         visible: true,
                //         labels: {
                //             enabled: true
                //         },
                //         tickAmount: 8,
                //         min: _root.graphAlarmMinValue,
                //         max: _root.graphAlarmMaxValue,
                //         plotLines: [{
                //             color: 'rgba(0, 160, 0, .5)',
                //             dashStyle: 'ShortDash',
                //             width: 1,
                //             zIndex: 2,
                //             value: _root.graphOptimumValue,
                //             label: {
                //                 text: 'Opt: ' + _root.graphOptimumValue
                //             }
                //         }, {
                //             color: 'rgba(255, 0, 0, .25)',
                //             dashStyle: 'ShortDash',
                //             width: 1,
                //             zIndex: 2,
                //             value: _root.graphAlarmMinValue,
                //             label: {
                //                 text: 'Min:' + _root.graphAlarmMinValue
                //             }
                //         }, {
                //             color: 'rgba(255, 0, 0, .25)',
                //             dashStyle: 'ShortDash',
                //             width: 1,
                //             zIndex: 2,
                //             value: _root.graphAlarmMaxValue,
                //             label: {
                //                 text: 'Max:' + _root.graphAlarmMaxValue
                //             }
                //         }]
                //     },
                //     tooltip: {
                //         shared: true,
                //         outside: true,
                //         split: false,
                //         borderColor: _color,
                //         borderWidth: 1,
                //         borderRadius: 10,
                //         shadow: false,
                //         style: {
                //             "color": "#3a3a3a",
                //             "cursor": "default",
                //             "fontSize": "12px",
                //             "pointerEvents": "none",
                //             "whiteSpace": "nowrap"
                //         }
                //     },

                //     plotOptions: {
                //         series: {
                //             zones: [{
                //                 value: _root
                //                     .graphAlarmMinValue, // Values up to 0 (not including) ...
                //                 color: _color
                //                 // color: 'rgba(255, 0, 0, 1)' // ... have the color blue
                //             }, {
                //                 value: _root
                //                     .graphOptimumValue, // Values up to 10 (not including) ...
                //                 color: _color
                //                 // color: 'rgba(0, 160, 0, 1)' // ... have the color orange
                //             }, {
                //                 color: _color
                //                 // color: 'rgba(255, 0, 0, 1)' // Values from 10 (including) and up have the color red
                //             }]
                //         }
                //     }
                // }, function (chart) {
                //     _root.chartReady = true
                // });
                if (document.getElementsByClassName("modal-backdrop")[0]) {
                    document.getElementsByClassName("modal-backdrop")[0].remove();
                    document.getElementsByTagName('body')[0].classList.remove('modal-open');
                }
            },

            _deleteGraph: function () {
                this.$.removeFromUserDashboard.generateRequest();
                // this.fire('refresh-dashboard', this.uid);
            },

            _editGraph: function () {

                var tagUnit = this.tagUnit = this.querySelector('#tagUnit' + this.uid).value || null;
                var graphPeriod = this.graphPeriod = parseInt(this.querySelector('#graphPeriod' + this.uid)
                    .value);
                var optimumValue = this.optimumValue = this.querySelector('#optimumValue' + this.uid)
                    .value || null;
                var alarmMinValue = this.alarmMinValue = this.querySelector('#alarmMinValue' + this.uid)
                    .value || null;
                var alarmMaxValue = this.alarmMaxValue = this.querySelector('#alarmMaxValue' + this.uid)
                    .value || null;
                var currentValue = this.currentValue = this.querySelector('#currentValue' + this.uid)
                    .checked;

                var updateUserDashboard = this.querySelector('#updateUserDashboard');

                var tagData = new FormData();
                tagData = {
                    'dashboard_id': this.graphDashboardId,
                    'unit': tagUnit,
                    'graph': graphPeriod,
                    'optimum_value': optimumValue,
                    'alarm_min_value': alarmMinValue,
                    'alarm_max_value': alarmMaxValue,
                    'current_value': currentValue,
                }
                updateUserDashboard.body = tagData;

                updateUserDashboard.generateRequest();
            },

            _onResponse_removeFromUserDashboard: function (e) {
                this.async(function () {
                    $('#deleteGraph' + this.uid).modal('hide');
                    this.fire('refresh-dashboard', this.uid);
                }, 300);
            },

            _onResponse_updateUserDashboard: function (e) {
                this.async(function () {
                    $('#editGraph' + this.uid).modal('hide');
                    this.fire('refresh-dashboard', this.uid);

                    this.graphOptimumValue = this.optimumValue;
                    this.graphAlarmMinValue = this.alarmMinValue;
                    this.graphAlarmMaxValue = this.alarmMaxValue;

                    /* this.hightStockChart.yAxis[0].options.plotLines[0].value = this.optimumValue;
                    this.hightStockChart.yAxis[0].options.plotLines[1].value = this.alarmMinValue;
                    this.hightStockChart.yAxis[0].options.plotLines[2].value = this.alarmMaxValue;
                    this.hightStockChart.yAxis[0].update(); */


                    this.end = new Date(this.graphDate);
                    this.start = moment(new Date(this.graphDate)).subtract(this.graphPeriod,
                        "hours").toDate();

                    this.$.getTagTrends.generateRequest();
                }, 300);
            },

            _markSelected: function (selectedDuration, duration) {
                if (selectedDuration === duration) {
                    return true
                } else {
                    return false
                }
            }
        });
    </script>

</dom-module>