<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html" />
<link rel="import" href="../../bower_components/global-var/global-var.html">
<dom-module id="asset-management-tag-list">

    <template>

        <style>
            #list,
            .crudPanel {
                min-width: 336px;
            }

            .list-container {
                height: calc(100vh - 10rem);
                overflow-y: auto;
            }

            .has-search .form-control {
                padding-left: 2.375rem;
            }

            .nav-link.active {
                background: #dee2e6;
            }

            .has-search .form-control-feedback {
                position: absolute;
                z-index: 2;
                display: block;
                width: 2.375rem;
                height: 2.375rem;
                line-height: 2rem;
                text-align: center;
                pointer-events: none;
                color: #aaa;
            }

            .type-red {
                color: #e80000
            }

            .type-orange {
                color: orange
            }

            .type-green {
                color: #007900
            }

            .list-group-item.active {
                background-color: #6c757d;
                border-color: rgba(0, 0, 0, .125);
                color: #efefef;
            }

            .list-group-item.active .text-black-50 {
                color: rgba(255, 255, 255, .75) !important;
            }


            .list.constrained.detail-active {
                display: none
            }

            .detail.list-active {
                display: none
            }

            .back-link {
                display: none
            }

            .detail.constrained .back-link {
                display: block
            }

            .detail.constrained.list-active {
                display: none
            }

            ::content .detail.constrained .detail-container {
                height: auto !important;
            }

            .detail {
                width: calc(100% - 25% - 64px);
            }

            .fa-bell {
                font-size: 18px;
            }

            ::content .filters-container {
                overflow-y: auto;
                background: #dee2e6;
            }



            #sortBy,
            #sortIcon {
                cursor: pointer;
            }


            .opcUATagtatus.high,
            .opcUAtatus.high {
                color: #d00000;
            }

            .opcUATagtatus.medium,
            .opcUAtatus.medium {
                color: #f2b600;
            }

            .opcUAtatus,
            .opcUAtatus.low,
            .opcUATagtatus.low,
            .opcUATagtatus.true {
                color: #4fbb00;
            }

            .opcUATagtatus.false {
                color: #dee2e6;
            }

            .header {
                align-items: center;
            }

            .btn-light {
                background-color: #dae0e5;
                border-color: #d3d9df;
            }

            .fa-link {
                transform: rotate(90deg);
                font-size: 9px;
                margin-top: 12px;
                margin-left: -5px;
            }

            ::-webkit-scrollbar {
                width: 10px;
                border-radius: 10px;
            }

            ::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }

            ::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 10px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: #555;
                border-radius: 10px;
            }

            .fas,
            .list-group-item-action {
                cursor: pointer;
            }

            .sidebar {
                overflow: hidden;
            }

            .editPanel {
                position: absolute;
                top: 5px;
                right: 0px;
            }

            .list-group :first-child {
                border-top: 0px;
            }

            .active {
                background-color: #6c757d;
                border-color: rgba(0, 0, 0, .125);
                color: #efefef;
            }

            .switch {
                transform: scale(0.7);
                position: relative;
                display: inline-block;
                width: 60px;
                height: 34px;
                margin-bottom: unset;
            }

            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                -webkit-transition: .4s;
                transition: .4s;
            }

            .slider:before {
                position: absolute;
                content: "";
                height: 26px;
                width: 26px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                -webkit-transition: .4s;
                transition: .4s;
            }

            input:checked+.slider {
                background-color: #2ecc71;
            }

            input:focus+.slider {
                box-shadow: 0 0 1px #2ecc71;
            }

            input:checked+.slider:before {
                -webkit-transform: translateX(26px);
                -ms-transform: translateX(26px);
                transform: translateX(26px);
            }

            /* Rounded sliders */
            .slider.round {
                border-radius: 34px;
            }

            .slider.round:before {
                border-radius: 50%;
            }

            .editControls button {
                width: 100%;
            }

            .tagName {
                word-wrap: break-word;
            }
        </style>


        <div class="d-flex">
            <template is="dom-if" if="[[listUnitItems]]" restamp>
                <div id="list" class="list   border-right p-0">
                    <div class="filters-container  p-2 border-bottom">
                        <div class="d-flex header">
                            <div class=" py-0 flex-fill lead">
                                <strong>Tag Mapping </strong>
                            </div>
                        </div>
                    </div>
                    <div class="px-2 pt-2 border-bottom bg-light">
                        <div class="form-group  my-1  mb-2 pb-1">
                            <input id="searchTagList" on-input="_addSelectedTag" list="tagList"
                                class="form-control form-control-sm" placeholder="Search/Add Tags" autocomplete="off"
                                required>

                            <datalist id="tagList">
                                <template is="dom-repeat" items="{{tagDataList}}">
                                    <option value="{{item.tag_name}}">{{item.description}}</option>
                                </template>
                            </datalist>
                        </div>
                    </div>

                    <div class="list-container position-sticky">
                        <template is="dom-if" if="{{!listUnitItems.0.tag_name}}" restamp>
                            <div class="text-muted text-center text-capitalize">{{listUnitItems.status}}</div>
                        </template>
                        <ul class="list-group list-group-flush  overflow-auto">
                            <template is="dom-repeat" items="{{listUnitItems}}" as="activeTags">
                                <li class="list-group-item px-2 py-1  border-bottom list-group-item-action">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <small class="small activeTagHeading">
                                                {{activeTags.tag_name}}</small>

                                            <div class="text-black-50 small text-capitalize activeTagDesc">
                                                {{activeTags.description}}</div>
                                        </div>
                                        <div><i data-tagName$="[[activeTags.tag_name]]" on-click="_removeAssetTag"
                                                class="fas fa-times-circle text-dark"></i>
                                        </div>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </template>
        </div>
        <global-loader>
            <iron-ajax auto id="getTagList" url="/getTagList" last-response="{{tagDataList}}"
                on-response="_onResponse_searchTag" on-error="_onError_searchTag"></iron-ajax>
        </global-loader>
        <global-loader>
            <iron-ajax method="POST" id="addAssetTag" url="/addAssetTag" handle-as="json"
                content-type="application/json" on-response="_onResponse_addAssetTag" on-error="_onError">
            </iron-ajax>
        </global-loader>
        <global-loader>
            <iron-ajax id="removeAssetTag" url="/removeAssetTag/[[selectedAsset]]/[[editTagName]]"
                on-response="_onResponse_removeAssetTag" on-error="_onError">
            </iron-ajax>
        </global-loader>

    </template>

    <script>
        Polymer({
            is: "asset-management-tag-list",
            behaviors: [
                Polymer.IronResizableBehavior
            ],
            listeners: {
                "iron-resize": "_calculateBounds"
            },
            properties: {
                /**
                 * Array of items to include in the list. Each item in the array should be an object with:
                 * - id (used for fetching the details view)
                 * - title
                 * - subtitle
                 * - severity (one of "important", "error", "warning", or "information")
                 * - date (optional, should be valid <a href="https://www.w3.org/TR/NOTE-datetime">8601 date strings</a>)
                 */
                /**
                 * ID of the selected item, for pulling up the details to display in the right side of the inbox view.
                 */
                selectedItem: {
                    type: String,
                    notify: true
                },
                /**
                 * Search query used to filter the list.
                 */
                _query: {
                    type: String
                },
                /**
                 * Property to sort the list by.
                 */
                sortBy: {
                    type: String,
                    value: "title"
                },
                /**
                 * Sort order - ascending or descending.
                 */
                sortOrder: {
                    type: String,
                    value: "ascending"
                },
                /**
                 * By default, the first item in the list will be selected.
                 * Set this flag to "true" to disable this default selection.
                 */
                disableAutoSelect: {
                    type: Boolean,
                    value: false
                }
            },
            created: function () {
                document.documentElement.classList.remove('in-progress');
            },
            attached: function () {
                this.async(function () {
                    $('[data-toggle="tooltip"]').tooltip();
                });
            },
            ready: function () {
            },
            _computeClass: function (selectedId, id) {
                return (selectedId && String(selectedId) === String(id)) ? 'active' : '';
            },
            _calculateBounds: function (evt) {
                this.debounce('resize', function () {
                    if (this.getBoundingClientRect().width < 700) {
                        this.toggleClass('constrained', true, this.$.list);
                        this.toggleClass('constrained', true, this.$.detail);

                        this.toggleClass('detail-active', false, this.$.list);
                        this.toggleClass('list-active', true, this.$.detail);

                    } else {
                        this.toggleClass('constrained', false, this.$.list);
                        this.toggleClass('constrained', false, this.$.detail);

                        this.toggleClass('detail-active', true, this.$.list);
                        this.toggleClass('list-active', false, this.$.detail);
                    }
                }, 300);
            },
            _computeFilter: function (query) {
                if (!query) {
                    // set filter to null to disable filtering
                    return null;
                } else {
                    // return a filter function for the current search query
                    query = query.toLowerCase();
                    return function (listItem) {
                        var tagName = listItem.tag_name.toLowerCase();
                        var AssetManagement = listItem.data_source.toLowerCase();

                        return (tagName.indexOf(query) != -1 ||
                            AssetManagement.indexOf(query) != -1);
                    };
                }
            },
            _computeSort: function (sortBy, sortOrder) {
                sortBy = sortBy ? sortBy.toLowerCase().replace(/\s+/g, '') : '';
                var asc = sortOrder === 'ascending';
                // return sort function which maps severities to numeric values
                if (asc) {
                    return function (a, b) {
                        return (a[sortBy] < b[sortBy]) ? -1 : (a[sortBy] > b[sortBy]) ? 1 : -1;
                    }
                } else if (!asc) {
                    return function (b, a) {
                        return (a[sortBy] < b[sortBy]) ? -1 : (a[sortBy] > b[sortBy]) ? 1 : 0;

                    }
                }
            },
            _reverseSort: function (e) {
                var id = e.currentTarget.id;
                var sectionId = id.slice(4, 20);
                var sort = 'sortIcon' + sectionId;
                this.async(function () {
                    if (this.sortOrder === 'ascending') {
                        this.sortOrder = 'descending';
                        document.getElementById(sort).classList.value = 'fas fa-arrow-up';
                    } else if (this.sortOrder === 'descending') {
                        this.sortOrder = 'ascending';
                        document.getElementById(sort).classList.value = 'fas fa-arrow-down';
                    }
                });

            },
            _updateClass: function () {
                this.debounce('_updateClass', function () {
                    if (this.$.list__body.scrollTop > 0) {
                        this.toggleClass('shadow-component', true, Polymer.dom(this.root)
                            .querySelector('.list__header'));
                    } else {
                        this.toggleClass('shadow-component', false, Polymer.dom(this.root)
                            .querySelector('.list__header'));
                    }
                }, 50);
            },
            _sortByChange: function (e) {
                this.set('sortBy', e.target.value)
            },
            _addSelectedTag: function (e) {
                var root = this;
                var val = document.getElementById("searchTagList").value;
                var opts = document.getElementById('tagList').childNodes;
                for (var i = 0; i < opts.length; i++) {
                    if (opts[i].value === val) {
                        var tagName = window.organization_id.toLowerCase() + '_' + e.target.value;
                        var addAssetTagBody = {
                            "asset_id": root.selectedAsset,
                            "tag_id": tagName
                        }
                        root.$.addAssetTag.body = addAssetTagBody;
                        root.$.addAssetTag.generateRequest();
                        document.getElementById("searchTagList").value = null;
                        break;
                    }
                }

            },
            _removeAssetTag: function (e) {
                var root = this;
                // if (e.target.value == root.tagDataList.tag_name) {
                var tagName = window.organization_id.toUpperCase() + '_' + e.currentTarget.dataset.tagname;
                root.editTagName = tagName;
                root.$.removeAssetTag.generateRequest();
                // }
            },
            _onResponse_addAssetTag: function (e) {
                document.getElementById('getAssetTags').generateRequest();
            },
            _onResponse_removeAssetTag: function (e) {
                document.getElementById('getAssetTags').generateRequest();
            },


        });
    </script>

</dom-module>