<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="global-loader/global-loader.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="dashboard-tab/dashboard-tab.html">

<dom-module id="view-dashboard">

    <template>

        <style>

            :host{
                display: block;
                min-height: 100%;
                padding-top: 48px;
                position: relative;
            }

            ::content ul.nav.nav-pills {
                z-index: 999;
                background-color: #272b30;
                overflow-x: auto;
                top: 56px;
            }

            ::content ul.nav.nav-pills .nav-link:not(.nav-plus) {
                position: relative;
                border-radius: 0;
                padding: .75rem 1.875rem;
                background-color: transparent;
                color: rgba(255, 255, 2552, .5);
                transition-delay: 300ms;
                transition: padding 300ms, box-shadow 600ms;
                white-space: nowrap;
            }

            ::content ul.nav.nav-pills .nav-link:not(.nav-plus).active {
                color: #6fb444;
                box-shadow: inset 0 -2px 0px 0px #f8f9fa;
            }

            ::content ul.nav.nav-pills .nav-link.active:not(.nav-plus):hover,
            ::content ul.nav.nav-pills .nav-link.active:not(.nav-plus):focus {
                padding-left: .5rem;
                padding-right: 3.25rem;
            }



            ::content ul.nav.nav-pills .nav-link button {
                display: none;
            }

            ::content ul.nav.nav-pills .nav-link.active:hover button.btn-edit,
            ::content ul.nav.nav-pills .nav-link.active:hover button.btn-delete,
            ::content ul.nav.nav-pills .nav-link.active:focus button.btn-edit,
            ::content ul.nav.nav-pills .nav-link.active:focus button.btn-delete {
                display: block;
                position: absolute;
                width: 20px;
                height: 20px;
                right: 0;
                border: 0;
                background-color: transparent;
                color: rgba(255, 255, 2552, .5);
                top: 50%;
                transform: translateY(-50%);
                line-height: 15px !important;
                border-radius: 20px;
                cursor: default;
                padding: 0;
                font-size: 10px;
                font-weight: 700;
                transition: all 300ms;
            }

            ::content ul.nav.nav-pills .nav-link.active:hover button.btn-edit,
            ::content ul.nav.nav-pills .nav-link.active:focus button.btn-edit {
                right: 0;
            }

            ::content ul.nav.nav-pills .nav-link.active:hover button.btn-delete,
            ::content ul.nav.nav-pills .nav-link.active:focus button.btn-delete {
                right: 25px;
            }

            ::content ul.nav.nav-pills .nav-link.active:hover button.btn-edit:hover,
            ::content ul.nav.nav-pills .nav-link.active:hover button.btn-edit:focus {
                box-shadow: 0 0 0 1px #6fb444;
                color: #6fb444;
            }

            ::content ul.nav.nav-pills .nav-link.active:hover button.btn-delete:hover,
            ::content ul.nav.nav-pills .nav-link.active:hover button.btn-delete:focus {
                box-shadow: 0 0 0 1px #dc3545;
                color: #dc3545;
            }

            ::content ul.nav.nav-pills .nav-plus {
                margin: .575rem auto;
                color: #6fb444 !important;
                background-color: #272b30;
                font-weight: 100;
                border-radius: 1rem;
                padding: 0;
                height: 30px;
                width: 30px;
                line-height: 25px;
                font-size: 30px;
                text-align: center;
                transition: all 300ms;
            }

            ::content ul.nav.nav-pills .nav-plus:hover {
                color: #272b30 !important;
                background-color: #6fb444;
            }

            ::content ul.nav.nav-pills .nav-plus:focus {
                box-shadow: 0 0 0 1px #6fb444;
            }

            ::content textarea {
                resize: none;
            }

            ::content .modal-dialog-scrollable .modal-body {
                overflow-y: auto;
                /* max-height: calc(100vh - 250px); */
            }

            /* ::content .tab-content,
            ::content .tab-pane{
                height: calc(100vh - 104px);
            } */

            ::content .label-required {
                color: #ab201d;
            }
        </style>

        <global-loader>
            <iron-ajax auto id="getMultiDashboard" url$="/getMultiDashboard/{{userId}}"
                on-response="_onResponse_getMultiDashboard">
            </iron-ajax>
        </global-loader>

        <global-loader>
            <iron-ajax id="updateMultiDashboard" method="POST" url="/updateMultiDashboard"
                headers='{"Content-Type": "application/json"}' on-response="_onResponse_updateMultiDashboard">
            </iron-ajax>
        </global-loader>

        <global-loader>
            <iron-ajax id="addMultiDashboard" method="POST" url="/addMultiDashboard"
                headers='{"Content-Type": "application/json"}' on-response="_onResponse_addMultiDashboard">
            </iron-ajax>
        </global-loader>

        <global-loader>
            <iron-ajax id="removeMultiDashboard" on-response="_onResponse_removeMultiDashboard">
            </iron-ajax>
        </global-loader>


        <ul class="nav nav-pills position-fixed w-100 flex-nowrap" id="myTab" role="tablist">
            <template is="dom-repeat" items="{{getMultiDashboardResponse}}">
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href$="#id{{item.dashboard_id}}" on-click="_gotoTab"
                        title="{{item.description}}">
                        <button class="btn-edit" on-click="_editDashboard"
                            title="Edit dashboard" data-dashboard$="{{item}}"><i class="fas fa-pen"></i></button>
                        <button class="btn-delete" on-click="_deleteDashboard"
                            title="Delete dashboard" data-dashboard$="{{item}}"><i class="fas fa-trash"></i></button>
                        <span>{{item.dashboard_name}}</span>
                    </a>
                </li>
            </template>

            <li class="nav-item ml-3">
                <a class="nav-link nav-plus" href="javascript:void(0)"
                    on-click="_createDashboard" title="Create dashboard">+</a>
            </li>
        </ul>
        <div class="tab-content">
            <template is="dom-repeat" items="{{getMultiDashboardResponse}}">
                <div class="tab-pane fade" id="id{{item.dashboard_id}}"></div>
            </template>
        </div>


        <!-- Modal - editDashboard -->
        <div class="modal" id="editDashboard" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit dashboard</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                            on-click="_closeModalEditDashboard">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>


                    <form id="editDashboardForm">
                        <div class="modal-body">

                            <div class="form-row">
                                <div class="col-md-10 form-group">
                                    <label for="editDashboardName">Name <span
                                            class="label-required">&#8727;</span></label>
                                    <input maxlength="100" type="text" class="form-control" id="editDashboardName" autocomplete="off"
                                        required value="{{currentDashboard.dashboard_name}}" onkeypress="return event.charCode >= 48">
                                </div>
                                <div class="col-md-2 form-group">
                                    <label for="editDashboardOrder">Order</label>
                                    <input maxlength="100" type="number" class="form-control" id="editDashboardOrder" autocomplete="off"
                                        value="{{currentDashboard.sort_id}}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-md-12 form-group">
                                    <label for="editDashboardDescription">Description</label>
                                    <textarea maxlength="400" class="form-control" id="editDashboardDescription" autocomplete="off"
                                        value="{{currentDashboard.description}}"></textarea>
                                </div>
                            </div>
                            <!-- <div class="form-row">
                                <div class="col-md-12 form-group">
                                    <label for="editRefreshInterval">Refresh interval</label>
                                    <select class="form-control" id="editRefreshInterval">
                                        <option value="30000"
                                            selected$="{{_markSelected(currentDashboard.dashboard_config.refresh_interval, 30000)}}">
                                            30 Seconds</option>
                                        <option value="60000"
                                            selected$="{{_markSelected(currentDashboard.dashboard_config.refresh_interval, 60000)}}">
                                            1 Minute</option>
                                        <option value="300000"
                                            selected$="{{_markSelected(currentDashboard.dashboard_config.refresh_interval, 300000)}}">
                                            5 Minutes</option>
                                        <option value="600000"
                                            selected$="{{_markSelected(currentDashboard.dashboard_config.refresh_interval, 600000)}}">
                                            10 Minutes</option>
                                    </select>
                                </div>
                            </div> -->

                        </div>
                    </form>

                    <div class="modal-footer align-items-stretch">
                        <div class="flex-grow-1">
                            <template is="dom-if" if="{{editDashboardStatus}}">
                                <div class$="alert {{_isSuccessfulAlertClass(editDashboardStatus)}} border-0 m-0 p-2"
                                    role="alert">
                                    {{editDashboardStatus}}
                                </div>
                            </template>
                        </div>

                        <template is="dom-if" if="{{!_isSuccessful(editDashboardStatus)}}">
                            <div class="flex-grow-0">
                                <button type="button" class="btn btn-light" data-dismiss="modal"
                                    on-click="_closeModalEditDashboard">Cancel</button>
                                <button class="btn btn-primary" on-click="_editDashboardSubmit">Save changes</button>
                            </div>
                        </template>
                    </div>


                </div>
            </div>
        </div>

        <!-- Modal - createDashboard -->
        <div class="modal" id="createDashboard" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create dashboard</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                            on-click="_closeModalCreateDashboard">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <form id="createDashboardForm">
                        <div class="modal-body">

                            <div class="form-row">
                                <div class="col-md-10 form-group">
                                    <label for="createDashboardName">Name <span
                                            class="label-required">&#8727;</span></label>
                                    <input maxlength="100" type="text" class="form-control" id="createDashboardName" autocomplete="off">
                                </div>
                                <div class="col-md-2 form-group">
                                    <label for="createDashboardOrder">Order</label>
                                    <input maxlength="100" type="number" class="form-control" id="createDashboardOrder"
                                        autocomplete="off">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="col-md-12 form-group">
                                    <label for="createDashboardDescription">Description</label>
                                    <textarea maxlength="400" class="form-control" id="createDashboardDescription"
                                        autocomplete="off"></textarea>
                                </div>
                            </div>

                            <!-- <div class="form-row">
                                <div class="col-md-12 form-group">
                                    <label for="createRefreshInterval">Refresh interval</label>
                                    <select class="form-control" id="createRefreshInterval">
                                        <option value="30000">30 Seconds</option>
                                        <option value="60000">1 Minute</option>
                                        <option value="300000">5 Minutes</option>
                                        <option value="600000">10 Minutes</option>
                                    </select>
                                </div>
                            </div> -->

                        </div>
                    </form>

                    <div class="modal-footer align-items-stretch">
                        <div class="flex-grow-1">
                            <template is="dom-if" if="{{createDashboardStatus}}">
                                <div class$="alert {{_isSuccessfulAlertClass(createDashboardStatus)}} border-0 m-0 p-2"
                                    role="alert">
                                    {{createDashboardStatus}}
                                </div>
                            </template>
                        </div>

                        <template is="dom-if" if="{{!_isSuccessful(createDashboardStatus)}}">
                            <div class="flex-grow-0">
                                <button type="button" class="btn btn-light" data-dismiss="modal"
                                    on-click="_closeModalCreateDashboard">Cancel</button>
                                <button class="btn btn-primary" on-click="_createDashboardSubmit">Create</button>
                            </div>
                        </template>
                    </div>


                </div>
            </div>
        </div>


        <!-- Modal - deleteDashboard -->
        <div class="modal" id="deleteDashboard" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addToDashboardTitle">Delete dashboard</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                            on-click="_closeModalDeleteDashboard">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <template is="dom-if" if="{{!_isSuccessful(deleteDashboardStatus)}}">
                        <div class="modal-body">
                            Are you sure, you want to delete current dashboard ?
                        </div>
                    </template>

                    <div class="modal-footer align-items-stretch">
                        <div class="flex-grow-1">
                            <template is="dom-if" if="{{deleteDashboardStatus}}">
                                <div class$="alert {{_isSuccessfulAlertClass(deleteDashboardStatus)}} border-0 m-0 p-2"
                                    role="alert">
                                    {{deleteDashboardStatus}}
                                </div>
                            </template>
                        </div>

                        <template is="dom-if" if="{{!_isSuccessful(deleteDashboardStatus)}}">
                            <div class="flex-grow-0">
                                <button type="button" class="btn btn-light" data-dismiss="modal"
                                    on-click="_closeModalDeleteDashboard">Cancel</button>
                                <button type="button" class="btn btn-danger"
                                    on-click="_deleteDashboardSubmit">Delete</button>
                            </div>
                        </template>
                    </div>

                </div>
            </div>
        </div>


    </template>


    <script>
        Polymer({
            is: "view-dashboard",

            properties: {
                userId: {
                    value: function () {
                        return window.user_id
                    }
                },
                orgId: {
                    value: function () {
                        return window.organization_id
                    }
                },
                getMultiDashboardResponse: {
                    value: null
                }
            },

            created: function () {
                /* console.log(this.localName + '#' + this.id + ' was created'); */
            },

            ready: function () {
                /* console.log(this.localName + '#' + this.id + ' has local DOM initialized'); */
            },

            attached: function () {
                /* console.log(this.localName + '#' + this.id + this.dashboardId + ' was attached'); */
                document.documentElement.classList.remove('in-progress');
                document.body.classList.add('bg-light');
            },

            detached: function () {
                /* console.log(this.localName + '#' + this.id + ' was detached'); */
                document.body.classList.remove('bg-light');
            },

            attributeChanged: function (name, type) {
                /* console.log(this.localName + '#' + this.id + ' attribute ' + name +
                    ' was changed to ' + this.getAttribute(name)); */
            },


            _markSelected: function (selectedDuration, duration) {
                // console.log('_markSelected', selectedDuration, duration);
                if (selectedDuration === duration) {
                    return true
                } else {
                    return false
                }
            },


            _isContain: function (inputString, searchString) {
                if (!inputString || !searchString) return;
                return inputString.toString().indexOf(searchString) > -1
            },


            _isSuccessfulAlertClass: function (inputString) {
                if (!inputString) return;
                if (inputString.indexOf('successfully') > -1) {
                    return 'alert-success'
                } else {
                    return 'alert-danger'
                }
            },

            _isSuccessful: function (inputString) {
                if (!inputString) return;
                return inputString.indexOf('successfully') > -1
            },

            _gotoTab: function (e) {
                e.preventDefault();
                e.stopPropagation();
                // e.currentTarget.blur();
                console.log('_gotoTab', e.currentTarget.href);
                $(e.currentTarget).tab('show');
            },

            _onResponse_getMultiDashboard: function (e) {
                var _this = this;

                if (e.detail.response && e.detail.response.status) {
                    _this.getMultiDashboardResponse = null;
                } else if (e.detail.response && !e.detail.response.status) {
                    _this.getMultiDashboardResponse = e.detail.response;
                }

                _this.async(function () {
                    var _tabId = location.hash.split('/').pop();
                    var _tabToShow = _this.querySelector('a[href*="id' + _tabId + '"]');

                    if (!_tabToShow) {
                        _firstTab = _this.querySelector('a[data-toggle="tab"]');
                        // console.log('_firstTab', _firstTab)
                        if (_firstTab) {
                            // _firstTab.click();
                            $(_firstTab).tab('show');

                            _tabId = _firstTab.href.split('#id')[1];
                            window.history.pushState(null, null, '#/dashboard/' + _tabId);
                        }

                    } else {
                        // console.log('_tabToShow', $(_tabToShow).tab('show'))
                        // _tabToShow.click();
                        $(_tabToShow).tab('show');
                    }

                    var _tabContainer = _this.querySelector('#id' + _tabId);
                    if (_tabContainer) {
                        _this._tabThisId = _tabId;
                        _tabContainer.innerHTML = '<dashboard-tab dashboard-id="' + _tabId + '"></dashboard-tab>';

                        // _this._dashboardLoaded();
                    }

                    $('a[data-toggle="tab"]').on('shown.bs.tab', function (t) {
                        if (t.relatedTarget) {
                            var prevTabId = t.relatedTarget.href.split('#id')[1];
                            _this.querySelector('#id' + prevTabId).innerHTML = null;
                            window.stop();
                        }
                        if (t.target) {
                            var _tabThisId = t.target.href.split('#id')[1];
                            _this._tabThisId = _tabThisId;
                            var _tabShownContainer = _this.querySelector('#id' + _tabThisId);
                            _tabShownContainer.innerHTML = '<dashboard-tab dashboard-id="' + _tabThisId + '"></dashboard-tab>';

                            window.history.pushState(null, null, '#/dashboard/' + _tabThisId);
                        }


                        // _this._dashboardLoaded();

                    });

                }, 100);



            },


            _dashboardLoaded: function () {
                /* var _this = this;
                _this.shownDashboardData = _this.getMultiDashboardResponse.find(function (e) {
                    return e.dashboard_id == _this._tabThisId
                }); */

                /* if (_this.shownDashboardData.dashboard_config && _this.shownDashboardData.dashboard_config.refresh_interval) {
                    _this.async(function () {
                        var _tabShownContainer = _this.querySelector('#id' + _this.shownDashboardData.dashboard_id);
                        _tabShownContainer.innerHTML = '<dashboard-tab dashboard-id="' + _this.shownDashboardData.dashboard_id + '"></dashboard-tab>';

                        console.log('refreshing dashboad after', _this.shownDashboardData.dashboard_config.refresh_interval);

                        _this._dashboardLoaded();
                    }, _this.shownDashboardData.dashboard_config.refresh_interval);
                } */
            },



            /*Edit Dashboard - START*/
            _editDashboard: function (e) {
                e.preventDefault();
                e.stopPropagation();

                
                $(this.$.editDashboard).modal({
                    keyboard: false,
                    backdrop: 'static'
                }).modal('show');

                console.log('_editDashboard', e.currentTarget)

                this.editDashboardStatus = null;


                this.currentDashboard = JSON.parse(e.currentTarget.dataset.dashboard);

                /* this.querySelector('#editDashboardName').value = this.currentDashboard.dashboard_name;
                this.querySelector('#editDashboardOrder').value = this.currentDashboard.sort_id;
                this.querySelector('#editDashboardDescription').value = this.currentDashboard.description;
                this.querySelector('#editDashboardDescription').value = this.currentDashboard.description; */

            },

            _editDashboardSubmit: function (e) {
                e.preventDefault();

                var editDashboardName = this.querySelector('#editDashboardName').value || null;
                var editDashboardOrder = this.querySelector('#editDashboardOrder').value || null;
                var editDashboardDescription = this.querySelector('#editDashboardDescription').value || null;

                // var editRefreshInterval = this.querySelector('#editRefreshInterval').value || null;
                // console.log('editRefreshInterval', editRefreshInterval)


                var updateMultiDashboard = this.querySelector('#updateMultiDashboard');

                var editDashboardData = new FormData();
                editDashboardData = {
                    'dashboard_id': this.currentDashboard.dashboard_id,
                    'user_id': this.userId,
                    'dashboard_name': editDashboardName,
                    'sort_id': editDashboardOrder,
                    'description': editDashboardDescription,
                    'dashboard_config': {
                        /* 'refresh_interval': editRefreshInterval */
                    }
                }
                // console.log('editDashboardData', editDashboardData);
                updateMultiDashboard.body = editDashboardData;

                updateMultiDashboard.generateRequest();
            },

            _onResponse_updateMultiDashboard: function (e) {
                // console.log('_onResponse_updateMultiDashboard', e.detail.response.status)
                if (e.detail.response && e.detail.response.status) {
                    this.editDashboardStatus = e.detail.response.status;
                }
            },

            _closeModalEditDashboard: function (e) {
                // console.log('_closeModalEditDashboard', e);
                if (this.editDashboardStatus/*  && this._isContain(this.editDashboardStatus, 'successfully') */) {
                    this.querySelector('#getMultiDashboard').generateRequest();
                }
            },
            /*Edit Dashboard - END*/



            /*Create Dashboard - START*/
            _createDashboard: function (e) {
                // e.preventDefault();
                console.log('_createDashboard', e, this);
                $(this.$.createDashboard).modal({
                    keyboard: false,
                    backdrop: 'static'
                }).modal('show');

                /* this.querySelector('#createDashboardName').value = null;
                this.querySelector('#createDashboardDescription').value = null; */

                this.$.createDashboardForm.reset();

                this.createDashboardStatus = null;
            },

            _createDashboardSubmit: function (e) {
                e.preventDefault();


                var createDashboardName = this.querySelector('#createDashboardName').value || null;
                var createDashboardOrder = this.querySelector('#createDashboardOrder').value || null;
                var createDashboardDescription = this.querySelector('#createDashboardDescription').value || null;

                // var createRefreshInterval = this.querySelector('#createRefreshInterval').value || null;
                // console.log('createRefreshInterval', createRefreshInterval)

                var addMultiDashboard = this.querySelector('#addMultiDashboard');

                var createDashboardData = new FormData();
                createDashboardData = {
                    'user_id': this.userId,
                    'dashboard_name': createDashboardName,
                    'sort_id': createDashboardOrder,
                    'description': createDashboardDescription,
                    'dashboard_config': {
                        /* 'refresh_interval': createRefreshInterval */
                    }
                }
                // console.log('createDashboardData', createDashboardData);
                addMultiDashboard.body = createDashboardData;

                addMultiDashboard.generateRequest();

            },

            _onResponse_addMultiDashboard: function (e) {
                // console.log('_onResponse_addMultiDashboard', e.detail.response.status);
                if (e.detail.response && e.detail.response.status) {
                    this.createDashboardStatus = e.detail.response.status;
                }
            },

            _closeModalCreateDashboard: function (e) {
                if (this.createDashboardStatus/*  && this._isContain(this.createDashboardStatus, 'successfully') */) {
                    this.querySelector('#getMultiDashboard').generateRequest();
                }

                $(e.target).modal('hide');
            },
            /*Create Dashboard - END*/



            /*Delete Dashboard - START*/
            _deleteDashboard: function (e) {
                e.preventDefault();

                $(this.$.deleteDashboard).modal({
                    keyboard: false,
                    backdrop: 'static'
                }).modal('show');

                this.deleteDashboardStatus = null;

                this.currentDashboard = JSON.parse(e.currentTarget.dataset.dashboard);
            },

            _deleteDashboardSubmit: function (e) {
                e.preventDefault();
                var removeMultiDashboard = this.querySelector('#removeMultiDashboard');
                removeMultiDashboard.url = '/removeMultiDashboard/' + this.currentDashboard.dashboard_id;
                removeMultiDashboard.generateRequest();
            },

            _onResponse_removeMultiDashboard: function (e) {
                // console.log('_onResponse_removeMultiDashboard', e.detail);
                if (e.detail.response && e.detail.response.status) {
                    this.deleteDashboardStatus = e.detail.response.status;
                }
            },

            _closeModalDeleteDashboard: function (e) {
                // console.log('_closeModalCreateDashboard', e);
                if (this.deleteDashboardStatus/*  && this._isContain(this.deleteDashboardStatus, 'successfully') */) {
                    this.querySelector('#getMultiDashboard').generateRequest();
                }
            }
            /*Delete Dashboard - END*/

        });
    </script>

</dom-module>